{% extends "base.html" %}

{% block title %}Products - Fresh Mart{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Filters Sidebar -->
        <div class="lg:w-1/4 xl:w-1/5">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <!-- Header -->
                <div class="p-4 bg-emerald-50 border-b border-emerald-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Filters</h2>
                        {% if selected_category or selected_subcategory or min_price or max_price %}
                        <button onclick="clearAllFilters()" 
                                class="text-sm text-emerald-600 hover:text-emerald-700 font-medium">
                            Clear all
                        </button>
                        {% endif %}
                    </div>
                </div>

                <div class="p-4 space-y-6">
                    <!-- Categories -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-sm font-semibold text-gray-900 mb-4">Categories</h3>
                        <div class="space-y-4 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                            {% for category in categories %}
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                           value="{{ category.id }}"
                                           {% if selected_category == category.id %}checked{% endif %}
                                           onchange="updateCategory(this.value, this.checked)">
                                    <span class="ml-2 text-sm font-medium text-gray-700">{{ category.name }}</span>
                                </label>
                                <div class="ml-6 space-y-2 subcategories" data-category="{{ category.id }}">
                                    {% if category.subcategories %}
                                        {% for subcategory in category.subcategories %}
                                        <label class="flex items-center">
                                            <input type="checkbox" 
                                                   class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                                   value="{{ subcategory.id }}"
                                                   {% if selected_subcategory == subcategory.id %}checked{% endif %}
                                                   onchange="updateFilters('subcategory', this.value, this.checked)">
                                            <span class="ml-2 text-sm text-gray-600">{{ subcategory.name }}</span>
                                        </label>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-sm font-semibold text-gray-900 mb-4">Price Range</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-500">Min (₹)</label>
                                    <input type="number" 
                                           id="min_price" 
                                           value="{{ min_price or '' }}"
                                           min="0" 
                                           placeholder="0"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Max (₹)</label>
                                    <input type="number" 
                                           id="max_price" 
                                           value="{{ max_price or '' }}"
                                           min="0" 
                                           placeholder="1000"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm">
                                </div>
                            </div>
                            <button onclick="applyPriceFilter()"
                                    class="w-full py-2 px-4 bg-emerald-50 text-emerald-600 rounded-md text-sm font-medium hover:bg-emerald-100 transition-colors">
                                Apply Price Filter
                            </button>
                        </div>
                    </div>

                    <!-- Sort By -->
                    <div>
                        <h3 class="text-sm font-semibold text-gray-900 mb-4">Sort By</h3>
                        <select onchange="updateSort(this.value)"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm">
                            <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
                            <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                            <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="flex-1">
            <!-- Products Count and Sort (Mobile) -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <p class="text-gray-600 mb-4 sm:mb-0">
                    Showing {{ products.items|length }} of {{ products.total }} products
                </p>
                <div class="w-full sm:w-auto">
                    <select onchange="updateSort(this.value)"
                            class="block w-full sm:w-48 rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm lg:hidden">
                        <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Sort by: Newest First</option>
                        <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Sort by: Price Low to High</option>
                        <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Sort by: Price High to Low</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for product in products.items %}
                <div class="group relative bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow duration-300">
                    <!-- Product Image -->
                    <div class="aspect-w-4 aspect-h-3">
                        <img src="{{ url_for('static', filename=product.image_url) }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-full object-cover">
                    </div>

                    <!-- Product Info -->
                    <div class="p-4">
                        <h3 class="text-sm font-medium text-gray-900">{{ product.name }}</h3>
                        <div class="mt-2 flex items-center">
                            <p class="text-lg font-semibold text-gray-900">₹{{ "%.2f"|format(product.price) }}</p>
                            {% if product.stock <= 0 %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                Out of Stock
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="absolute inset-0 bg-black bg-opacity-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center gap-2">
                        <a href="{{ url_for('product_details', id=product.id) }}"
                           class="p-2 bg-white rounded-full hover:bg-gray-100 transition-colors duration-200">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </a>
                        <button type="button" 
                                onclick="addToWishlist({{ product.id }}); return false;"
                                class="p-2 bg-white rounded-full hover:bg-gray-100 transition-colors duration-200">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if products.pages > 1 %}
            <div class="mt-8 flex justify-center">
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {% if products.has_prev %}
                    <a href="{{ url_for('products', page=products.prev_num, category=selected_category, subcategory=selected_subcategory, min_price=min_price, max_price=max_price, sort=sort) }}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Previous</span>
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </a>
                    {% endif %}

                    {% for page_num in products.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                    {% if page_num %}
                    <a href="{{ url_for('products', page=page_num, category=selected_category, subcategory=selected_subcategory, min_price=min_price, max_price=max_price, sort=sort) }}"
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium {% if page_num == products.page %}text-emerald-600 bg-emerald-50{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                        {{ page_num }}
                    </a>
                    {% else %}
                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                        ...
                    </span>
                    {% endif %}
                    {% endfor %}

                    {% if products.has_next %}
                    <a href="{{ url_for('products', page=products.next_num, category=selected_category, subcategory=selected_subcategory, min_price=min_price, max_price=max_price, sort=sort) }}"
                       class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Next</span>
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 2px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}
</style>

<script>
function updateFilters(type, value, checked) {
    const urlParams = new URLSearchParams(window.location.search);
    
    if (checked) {
        urlParams.set(type, value);
    } else {
        urlParams.delete(type);
    }
    
    window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
}

function applyPriceFilter() {
    const minPrice = document.getElementById('min_price').value;
    const maxPrice = document.getElementById('max_price').value;
    const urlParams = new URLSearchParams(window.location.search);
    
    if (minPrice) urlParams.set('min_price', minPrice);
    else urlParams.delete('min_price');
    
    if (maxPrice) urlParams.set('max_price', maxPrice);
    else urlParams.delete('max_price');
    
    window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
}

function updateSort(value) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('sort', value);
    window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
}

function clearAllFilters() {
    window.location.href = window.location.pathname;
}

function addToWishlist(productId) {
    // Implement wishlist functionality
    console.log('Adding to wishlist:', productId);
}

function updateCategory(categoryId, checked) {
    // Clear all subcategory checkboxes
    document.querySelectorAll('.subcategories input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Update category filter
    updateFilters('category', categoryId, checked);
    
    if (checked) {
        // Fetch subcategories for the selected category
        fetch(`/api/subcategories/${categoryId}`)
            .then(response => response.json())
            .then(subcategories => {
                // Get the subcategories container for this category
                const container = document.querySelector(`.subcategories[data-category="${categoryId}"]`);
                container.innerHTML = ''; // Clear existing subcategories
                
                // Add new subcategories
                subcategories.forEach(sub => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center';
                    label.innerHTML = `
                        <input type="checkbox" 
                               class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                               value="${sub.id}"
                               onchange="updateFilters('subcategory', this.value, this.checked)">
                        <span class="ml-2 text-sm text-gray-600">${sub.name}</span>
                    `;
                    container.appendChild(label);
                });
            });
    } else {
        // Clear subcategories when category is unchecked
        const container = document.querySelector(`.subcategories[data-category="${categoryId}"]`);
        container.innerHTML = '';
    }
}
</script>
{% endblock %} 